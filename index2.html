<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hello World!</title>
</head>
<body>

<div style="display: flex">
  <textarea rows='20' style="width: 100%" oninput="handleMarkdown()" id="markdown"># This is heading 1

## Heading 2

### Heading 2

This is paragraph


* This is a list
* this is another item
  </textarea>

  <style>
      table td, table th {
          border: 1px solid #000;
      }

      table {
          border-collapse: collapse;
      }
  </style>

  <div style="width: 100%; margin-left: 8px;" id="html"></div>
</div>

<textarea id='output' style='width: 100%; margin-top: 20px;' rows='6' disabled></textarea>

<script type="text/javascript">
  window.languagePluginUrl = 'https://cdn.jsdelivr.net/pyodide/v0.16.1/full/';
</script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.16.1/full/pyodide.js"></script>
<script>
  const output = document.getElementById("output");
  const markdown = document.getElementById("markdown");
  const html = document.getElementById("html");

  let changed = false;

  output.value = 'Initializing...\n';
  // init Pyodide
  languagePluginLoader.then(async () => {
    await pyodide.runPythonAsync(`
      import micropip
      micropip.install('markdown')
      micropip.install('pymdown-extensions')
      micropip.install('pygments')
    `);
    await pyodide.runPythonAsync(`
      from markdown import Markdown

      MD_EXTENSIONS = [
        'footnotes',
        'def_list',
        'toc',
        'pymdownx.arithmatex',
        'pymdownx.betterem',
        'pymdownx.caret',
        'pymdownx.critic',
        'pymdownx.details',
        'pymdownx.inlinehilite',
        'pymdownx.magiclink',
        'pymdownx.mark',
        'pymdownx.smartsymbols',
        'pymdownx.superfences',
        'pymdownx.tasklist',
        'pymdownx.tilde',
        'pymdownx.pathconverter',
        'admonition',
        'meta',
        'codehilite',
        'tables',
      ]
      MD_EXTENSIONS_CONFIG = {
        'pymdownx.pathconverter': {
          'base_path': '/GCS/POST_STORAGE_BUCKET/BLOG_NAME/POST_SLUG/',
          'absolute': True,
          'tags': 'img',
        },
        'toc': {
          'marker': '',
          'permalink': True,
        },
        'pymdownx.arithmatex': {
          'generic': True,
        },
        'pymdownx.betterem': {
          'smart_enable': 'all',
        },
        'pymdownx.tasklist': {
          'custom_checkbox': 'true',
        }
      }
    `);
    output.value += 'Ready!\n';

    html.innerHTML = parseMd(markdown.value);
  });

  function handleMarkdown() {
    changed = true;
  }

  setInterval(() => {
    if (changed) {
      html.innerHTML = parseMd(markdown.value);
      changed = false
    }
  }, 1000);

  function parseMd(md) {
    return pyodide.runPython(`
md = Markdown(extensions=MD_EXTENSIONS, extension_configs=MD_EXTENSIONS_CONFIG)
md.convert("""${md}""")
    `);
  }
</script>
</body>
</html>
